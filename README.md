# 前言
https://github.com/Saqoosha/IMDAvoider/blob/main/imd.py から派生したものです。 日本のアマチュア無線のバンドプランの変更によりVTX電波の4波同時運用の可能性を探るものです。オリジナルのIMDツール http://etserv.etheli.com/IMDTabler/run は二つの周波数の合成による影響を計算するものでした。各所での実験の結果(主には屋内で飛行する環境で)、それだけでは見つけられない不具合があることがほぼ確実です。これについては以下のXのスレッドをご覧ください。 https://x.com/hm4649/status/1948715651050226077 そこで3波を合成した時に発生する周波数成分を考慮するように書き直してみました。

2波で生成されるノイズと3波で生成されるノイズは強度が大きく違います。それ故、元々のIMD測定ツールは2次合成だけを計算しているものと想像します。最初、calculate_4freq_ratings.pyで2次合成も3次合成も同じ基準で評価しました。やはりこれでは無理がある気がしましたので評価方式を刷新しました。

新しい評価方法では従来の2波合成による評価リストをまず作成し、そのリストに対して3波合成による評価を行うことにしました。3波合成評価で注目するのは合成で得られた周波数とVTXチャネル周波数との差がどれだけあるかです。規定値ではその差が20MHz未満は不合格としていますが、3次合成波はかなり微弱になると想像されるため、この数値は小さくしても構わないかも知れません。これを小さくすると2波合成の評価値の高いものが選ばれる効果があります。

# IMD (Intermodulation Distortion) 計算ツール

このプロジェクトは、複数の周波数における相互変調歪み（IMD）を計算し、最適な周波数組み合わせを見つけるためのツールです。

## 概要

VTX（Video Transmitter）システムにおいて、複数の周波数を同時に使用する際に発生する相互変調歪みを評価し、干渉を最小化する周波数組み合わせを特定します。

## ファイル構成

### メインモジュール
- `imd.py` - 二次合成によるIMD計算モジュール
- `imd3.py` - 三次合成によるIMD計算モジュール

### ワークフロースクリプト
- `create_secondary_ranking.py` - 二次合成による評価と順位リスト作成
- `apply_tertiary_filter.py` - 三次合成による評価と近接周波数フィルタリング
- `run_complete_workflow.py` - 完全なワークフロー実行スクリプト

### 4. 三次合成評価とフィルタリング (`apply_tertiary_filter.py`)

#### 機能
- `secondary_ranking.txt` を読み込み、三次合成評価を追加
- IMD差が閾値未満の組み合わせをフィルタリング
- 結果を `filtered_ranking.txt` に保存

#### 使用方法
```bash
# デフォルト設定で実行 (IMD差の閾値: 20MHz)
python3 apply_tertiary_filter.py

# IMD差の閾値を15MHzに変更して実行
python3 apply_tertiary_filter.py --imd-diff-threshold 15
```

#### オプション
- `--imd-diff-threshold`: IMD差フィルタの閾値（MHz）。この値未満のIMD差を持つ周波数の組み合わせは排除対象となります。デフォルトは20です。

### 従来のスクリプト
- `calculate_4freq_ratings.py` - 4周波数組み合わせの評価スクリプト

### 設定ファイル
- `vtxtable.txt` - 周波数とチャネルの対応表
- `LED.txt` - 周波数レンジとLED番号の対応表
- `freq.txt` - 評価対象周波数リスト

### 出力ファイル
- `secondary_ranking.txt` - 二次合成による順位リスト
- `filtered_ranking.txt` - 三次合成評価とフィルタリング結果
- `result.txt` - 計算結果出力ファイル

## 機能

### 1. 完全ワークフロー (`run_complete_workflow.py`)

#### 新しい評価システム
1. **二次合成による評価**: `imd.py`を使用して全ての4周波数組み合わせを評価
2. **順位リスト作成**: 評価値でソートされた順位リストを生成
3. **三次合成による評価**: `imd3.py`を使用して三次合成による干渉を評価
4. **IMD差フィルタリング**: `imd3.py`のcalcRatingルーチン内で計算されるdifferenceが20MHz未満の組み合わせを排除

#### 使用方法

```bash
# 完全なワークフローを実行
python3 run_complete_workflow.py
```

#### 出力ファイル
- `secondary_ranking.txt`: 二次合成による順位リスト
- `filtered_ranking.txt`: 三次合成評価とフィルタリング結果

### 2. 二次合成評価 (`imd.py`)

#### 基本機能
- 二次合成（2*f1 - f2）の計算
- 周波数間の干渉評価
- シンプルな評価システム

#### 使用方法

```bash
# 特定の周波数で評価
python3 imd.py
```

### 3. 三次合成評価 (`imd3.py`)

#### 基本機能
- 三次合成（10パターン）の計算
- 周波数間の干渉評価
- チャネル名付き周波数表示

#### 三次合成パターン
1. f1 - f2 + f3
2. f1 + f2 - f3
3. 2*f1 - f2 - f3
4. f1 + f2 + f3
5. -f1 + f2 + f3
6. 2*f1 + f2 - f3
7. 2*f1 - f2 + f3
8. f1 - 2*f2 + f3
9. f1 + 2*f2 - f3
10. -f1 + 2*f2 + f3

#### 使用方法

```bash
# デフォルト周波数で評価
python3 imd3.py

# 特定の周波数で評価
python3 imd3.py 5685 5705 5769 5809

# デバッグモードで評価
python3 imd3.py --debug 5685 5705 5769 5809
```

#### 出力例
```
評価対象周波数: ['(E2)5685', '(E1)5705', '(R4)5769', '(B5)5809']
最終評価: -376
```

### 4. 4周波数組み合わせ評価 (`calculate_4freq_ratings.py`)

#### 機能
- `freq.txt`から周波数を読み込み
- 全ての4周波数組み合わせを評価
- LED番号付きで結果を表示
- 評価値でソートして表示

#### 使用方法
```bash
python3 calculate_4freq_ratings.py
```

#### 出力例
```
  1. 周波数: [5685(LED3), 5705(LED3), 5769(LED4), 5809(LED4)] -> 評価値: -245
  2. 周波数: [5685(LED3), 5705(LED3), 5769(LED4), 5815(LED4)] -> 評価値: -267
  ...

最高評価値: -245
最適な4周波数組み合わせ: [5685(LED3), 5705(LED3), 5769(LED4), 5809(LED4)]
```

## 設定ファイル

### vtxtable.txt
周波数とチャネル名の対応表
```
BOSCAM_A A FACTORY 5865 5845 5825 5805 5785 5765 5745 5725
BOSCAM_B B FACTORY 5733 5752 5771 5790 5809 5828 5847 5866
...
```

### LED.txt
周波数レンジとLED番号の対応表
```
5100-5199 LED1
5200-5299 LED2
5300-5399 LED3
...
```

### freq.txt
評価対象周波数のリスト
```
5685
5705
5725
...
```

## 評価システム

### 二次合成評価 (`imd.py`)
- **基本値**: 100点
- **減点**: 二次合成干渉パターンに対して計算
- **計算式**: `RATING_MAX_VALUE - total / 5 / n`
- **干渉判定**: 差が35MHz以下で評価対象

### 三次合成評価 (`imd3.py`)
- **基本値**: 100点
- **減点**: 三次合成干渉パターン（10パターン）に対して計算
- **計算式**: `RATING_MAX_VALUE - total / 5 / n`
- **干渉判定**: 差が35MHz以下で評価対象

### IMD差フィルタリング
- **排除基準**: `imd3.py`のcalcRatingルーチン内で計算されるdifferenceが指定した閾値未満の組み合わせ。
- **対象**: 二次合成と三次合成（10パターン）の全てのdifference
- **目的**: 実用的な周波数間隔を確保
- **閾値の変更**: `apply_tertiary_filter.py`実行時に`--imd-diff-threshold`オプションで変更できます。（デフォルト: 20MHz）

### 評価基準
- 評価値が高いほど良い組み合わせ
- 干渉が少ないほど高評価
- 周波数間の距離が適切なほど高評価

## デバッグ機能

`--debug`オプションを使用すると、以下の情報が表示されます：
- 二次合成の計算過程
- 三次合成の各パターンの計算過程
- 対象周波数と最近接周波数の比較
- 評価値の計算過程

## 技術仕様

- **対応周波数範囲**: 5100-6099 MHz
- **評価差限界**: 35 MHz
- **最大評価値**: 100点
- **対応チャネル**: A, B, E, F, Rバンド

## 注意事項

1. 必要なファイル（vtxtable.txt, LED.txt, freq.txt）が存在することを確認してください
2. 周波数は整数値で指定してください
3. デバッグモードは大量の出力を生成するため、必要時のみ使用してください

# 評価
3次合成波による評価の際に閾値を規定値の20MHz以外に18, 15, 10, 5でも評価を行いました。得られたfiltered_rankinf.txtからKEEPとマークされた行を抽出したものが以下のファイルです。
- [filter20.txt](/filter20.txt)
- [filter15.txt](/filter15.txt)
- [filter18.txt](/filter18.txt)
- [filter15.txt](/filter15.txt)
- [filter5.txt](/filter5.txt)

閾値を小さくすると二次合成波での成績が良いものが残る傾向にあります。閾値の見極めはなかなか難しく実テストを行なってみるしかないように思います。

LEDを装着してその色をVTX周波数により変更することが出来ます。問題は色が変化する周波数レンジが決め打ちされていることです。レースを行う際に各機別々のLED色にすめためには周波数に注意する必要があります。上のリストでLED safeと記されたものはLED色が4波とも違うものが選べるものです。

## 私的な実テスト予定リスト
全くの勘により以下の組み合わせを抽出しました。これを機会があればテストしてみたいと考えています。
### 閾値5MHz
```
   4, (R2)5695[LED2], (A8)5725[LED3], (A5)5785[LED4], (F5)5820[LED6], 86, -1039, KEEP LED safe,
```
### 閾値10MHz
```
   2, (E2)5685[LED2], (A8)5725[LED3], (B4)5790[LED6], (F5)5820[LED6], 88, -708, KEEP, 
  23, (R2)5695[LED2], (A8)5725[LED3], (A5)5785[LED4], (A4)5805[LED6], 74, -826, KEEP LED safe, 
```

### 閾値15MHz
```
   9, (E2)5685[LED2], (E1)5705[LED2], (F3)5780[LED4], (F5)5820[LED6], 78, -328, KEEP, 
  37, (E1)5705[LED2], (A8)5725[LED3], (A5)5785[LED4], (F5)5820[LED6], 68, -578, KEEP LED safe, 
```

### 閾値18MHz
```
   9, (E2)5685[LED2], (E1)5705[LED2], (F3)5780[LED4], (F5)5820[LED6], 78, -328, KEEP, 
  58, (E2)5685[LED2], (A8)5725[LED3], (A5)5785[LED4], (R5)5806[LED6], 58, -434, KEEP LED safe, 
```

閾値20MHz
```
   9, (E2)5685[LED2], (E1)5705[LED2], (F3)5780[LED4], (F5)5820[LED6], 78, -328, KEEP, 
  75, (E2)5685[LED2], (A8)5725[LED3], (A5)5785[LED4], (A4)5805[LED6], 55, -418, KEEP LED safe, 
```


## ライセンス

このプロジェクトはMITライセンスの下で公開されています。 
